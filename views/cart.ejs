<%- include('partials/header', { title: 'Cart', user: user }) %>

<section class="section-padding">
  <div class="container">

    <% if (message) { %>
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        <%= message %>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    <% } %>

    <% if (danger) { %>
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <%= danger %>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    <% } %>

    <h2 class="mb-4">Your Cart</h2>

    <% if (cart && cart.items && cart.items.length > 0) { %>

      <div class="cart-table custom-block bg-white shadow p-3 mb-5">

        <!-- Table headings are only visible on larger screens -->
        <div class="cart-header row fw-bold border-bottom pb-3 mb-3 d-none d-md-flex">
          <div class="col-md-2">Image</div>
          <div class="col-md-2">Item</div>
          <div class="col-md-3">Description</div>
          <div class="col-md-1">Price</div>
          <div class="col-md-2">Qty</div>
          <div class="col-md-2">Actions</div>
        </div>

        <% cart.items.forEach((i, idx) => { %>
          <% 
            const isSingleItem = cart.items.length === 1;
            const isLastItem = idx === cart.items.length - 1;
            const borderClass = (!isSingleItem && !isLastItem) ? 'border-bottom' : '';
          %>

          <% if (i.type === 'menuItem' && i.menuItem) { %>
            <div class="cart-row row align-items-center <%= borderClass %> py-3">
              <div class="col-12 col-md-2 mb-2 mb-md-0 text-center">
                <img src="<%= i.menuItem.imageUrl %>" width="75" class="rounded">
              </div>
              <div class="col-12 col-md-2 mb-2 mb-md-0 text-center text-md-start">
                <%= i.menuItem.name %>
              </div>
              <div class="col-12 col-md-3 mb-2 mb-md-0 text-center text-md-start">
                <%= i.menuItem.description %>
              </div>
              <div class="col-12 col-md-1 mb-2 mb-md-0 text-center text-md-start text-danger fw-bold">
                $<%= i.calculatedPrice.toFixed(2) %>
              </div>
              <div class="col-12 col-md-2 mb-2 mb-md-0">
                <form method='POST' action='/cart/update/<%= i._id %>' class="d-flex justify-content-center justify-content-md-start gap-2">
                  <input type='number' name='quantity' value='<%= i.quantity %>' min='1' class='form-control small-input'>
                  <button class="btn custom-btn small-btn">Update</button>
                </form>
              </div>
              <div class="col-12 col-md-2 text-center text-md-start">
                <form action='/cart/delete/<%= i._id %>' method='POST'>
                  <button class="btn custom-btn custom-border-btn small-btn">Remove</button>
                </form>
              </div>
            </div>
          <% } else if (i.type === 'pizza' && i.customPizza) { %>
            <div class="cart-row row align-items-center <%= borderClass %> py-3">
              <div class="col-12 col-md-2 mb-2 mb-md-0 text-center">
                <img src="<%= i.customPizza.imageUrl %>" width="75" class="rounded">
              </div>
              <div class="col-12 col-md-2 mb-2 mb-md-0 text-center text-md-start">
                <%= i.customPizza.size %> (Custom)
              </div>
              <div class="col-12 col-md-3 mb-2 mb-md-0 text-center text-md-start">
                <strong>Crust:</strong> <%= i.customPizza.crust %><br>
                <strong>Sauce:</strong> <%= i.customPizza.sauce %><br>
                <strong>Cheese:</strong> <%= i.customPizza.cheese %><br>
                <strong>Toppings:</strong>
                <%= i.customPizza.toppings?.length
                      ? i.customPizza.toppings.map(t => t.name + (t.region ? ' (' + t.region + ')' : '')).join(', ')
                      : 'None' %>
              </div>
              <div class="col-12 col-md-1 mb-2 mb-md-0 text-center text-md-start text-danger fw-bold">
                $<%= i.calculatedPrice.toFixed(2) %>
              </div>
              <div class="col-12 col-md-2 mb-2 mb-md-0">
                <form method='POST' action='/cart/update/<%= i._id %>' class="d-flex justify-content-center justify-content-md-start gap-2">
                  <input type='number' name='quantity' value='<%= i.quantity %>' min='1' class='form-control small-input'>
                  <button class="btn custom-btn small-btn">Update</button>
                </form>
              </div>
              <div class="col-12 col-md-2 text-center text-md-start">
                <form action='/cart/delete/<%= i._id %>' method='POST'>
                  <button class="btn custom-btn custom-border-btn small-btn">Remove</button>
                </form>
              </div>
            </div>
          <% } %>
        <% }); %>
      </div>

      <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mt-4">
        <h5 class="fw-bold text-center text-md-start">Total: $<%= total.toFixed(2) %></h5>
        <div class="d-flex flex-column flex-md-row gap-3 w-100">
          <a href="/menu" class="btn custom-btn custom-border-btn w-100 w-md-auto">Back to Menu</a>
          <form action="/cart/clear" method="POST" class="w-100 w-md-auto">
            <button type="submit" class="btn custom-btn custom-border-btn w-100 w-md-auto">Clear Cart</button>
          </form>
          <a href="/cart/checkout" class="btn custom-btn w-100 w-md-auto">Proceed to Checkout</a>
        </div>
      </div>

    <% } else { %>
      <p>Your cart is empty.</p>
      <a href="/menu" class="btn custom-btn">Browse Menu</a>
    <% } %>

  </div>
</section>

<%- include('partials/footer') %>

<style>
  .small-input {
    width: 70px;
  }
  .small-btn {
    padding: 0.3rem 0.75rem;
    font-size: 0.9rem;
  }
</style>
