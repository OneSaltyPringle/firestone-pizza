<%- include('partials/header', { title: 'Admin Panel', user }) %>

<section class="admin-panel-section section-padding">
  <div class="container">
    <div class="admin-panel">
      <!-- Sidebar -->
      <aside class="admin-sidebar">
        <h3>Admin Menu</h3>

        <div class="accordion-group">
          <button class="accordion-toggle">Builder Management</button>
          <ul class="accordion-content">
            <li><a href="#" data-target="#sectionToppings" class="admin-link active">Builder Toppings</a></li>
            <li><a href="#" data-target="#sectionCrusts" class="admin-link">Builder Crusts</a></li>
            <li><a href="#" data-target="#sectionSauces" class="admin-link">Builder Sauces</a></li>
            <li><a href="#" data-target="#sectionCheeses" class="admin-link">Builder Cheeses</a></li>
          </ul>
        </div>

        <div class="accordion-group">
          <button class="accordion-toggle">Menu Management</button>
          <ul class="accordion-content">
            <li><a href="#" data-target="#sectionCategories" class="admin-link">Menu Categories</a></li>
            <li><a href="#" data-target="#sectionMenuItems" class="admin-link">Menu Items</a></li>
          </ul>
        </div>
      </aside>

      <!-- Content Area -->
      <div class="admin-content">
        <div id="sectionToppings" class="admin-section">
          <%- include('partials/admin-section', {
                title: 'Manage Builder Toppings',
                id: 'sectionToppings',
                formAction: '/admin/topping',
                fields: [
                  { name: 'name', placeholder: 'Topping Name', required: true },
                  { name: 'image', placeholder: 'Image Filename' },
                  { name: 'price', placeholder: 'Price', type: 'number', step: '0.01', required: true },
                  { name: 'category', placeholder: 'Category (optional)' }
                ],
                data: toppings,
                updateActionBase: '/admin/topping/edit',
                deleteActionBase: '/admin/topping/delete'
          }) %>
        </div>

        <div id="sectionCrusts" class="admin-section hidden">
          <%- include('partials/admin-section', {
                title: 'Manage Builder Crusts',
                id: 'sectionCrusts',
                formAction: '/admin/crust',
                fields: [
                  { name: 'name', placeholder: 'Crust Name', required: true },
                  { name: 'image', placeholder: 'Image Filename' },
                  { name: 'price', placeholder: 'Price', type: 'number', step: '0.01', required: true },
                  { name: 'category', placeholder: 'Category (optional)' }
                ],
                data: crusts,
                updateActionBase: '/admin/crust/update',
                deleteActionBase: '/admin/crust/delete'
          }) %>
        </div>

        <div id="sectionSauces" class="admin-section hidden">
          <%- include('partials/admin-section', {
                title: 'Manage Builder Sauces',
                id: 'sectionSauces',
                formAction: '/admin/sauce',
                fields: [
                  { name: 'name', placeholder: 'Sauce Name', required: true },
                  { name: 'image', placeholder: 'Image Filename' },
                  { name: 'price', placeholder: 'Price', type: 'number', step: '0.01', required: true },
                  { name: 'category', placeholder: 'Category (optional)' }
                ],
                data: sauces,
                updateActionBase: '/admin/sauce/update',
                deleteActionBase: '/admin/sauce/delete'
          }) %>
        </div>

        <div id="sectionCheeses" class="admin-section hidden">
          <%- include('partials/admin-section', {
                title: 'Manage Builder Cheeses',
                id: 'sectionCheeses',
                formAction: '/admin/cheese',
                fields: [
                  { name: 'name', placeholder: 'Cheese Name', required: true },
                  { name: 'image', placeholder: 'Image Filename' },
                  { name: 'price', placeholder: 'Price', type: 'number', step: '0.01', required: true },
                  { name: 'category', placeholder: 'Category (optional)' }
                ],
                data: cheeses,
                updateActionBase: '/admin/cheese/update',
                deleteActionBase: '/admin/cheese/delete'
          }) %>
        </div>

        <div id="sectionCategories" class="admin-section hidden">
          <%- include('partials/admin-section', {
                title: 'Manage Menu Categories',
                id: 'sectionCategories',
                formAction: '/admin/category/add',
                fields: [
                  { name: 'name', placeholder: 'Category Name', required: true },
                  { name: 'description', placeholder: 'Description (optional)' }
                ],
                data: categories,
                updateActionBase: '/admin/category/update',
                deleteActionBase: '/admin/category/delete'
          }) %>
        </div>

        <div id="sectionMenuItems" class="admin-section hidden">
          <%- include('partials/admin-section', {
                title: 'Manage Menu Items',
                id: 'sectionMenuItems',
                formAction: '/admin/menu/add',
                fields: [
                  { name: 'name', placeholder: 'Item Name', required: true },
                  { name: 'description', placeholder: 'Description' },
                  { name: 'price', placeholder: 'Price', type: 'number', step: '0.01', required: true },
                  { name: 'imageUrl', placeholder: 'Image URL' },
                  {
                    name: 'category',
                    placeholder: 'Menu Category',
                    type: 'select',
                    required: true,
                    options: [
                      { value: '', label: 'Uncategorized' },
                      ...categories.map(c => ({
                        value: c._id,
                        label: c.name
                      }))
                    ]
                  },
                  { name: 'isPizza', placeholder: 'Is Pizza?', type: 'checkbox' }
                ],
                data: menuItems,
                updateActionBase: '/admin/menu/edit',
                deleteActionBase: '/admin/menu/delete'
          }) %>
        </div>
      </div>
    </div>
  </div>
</section>

<%- include('partials/footer') %>

<style>
  @media (max-width: 767.98px) {
    .admin-panel .custom-block form input,
    .admin-panel .custom-block form select,
    .admin-panel .custom-block form button {
      width: 100% !important;
      margin-bottom: 0.5rem;
    }
    .admin-table-container {
      overflow-x: auto;
    }
    .admin-table {
      min-width: 600px;
    }
    .admin-panel .actions {
      flex-wrap: wrap;
    }
    .admin-panel .actions form {
      flex: 1 1 auto;
    }
    .admin-panel .actions .btn {
      width: 100%;
      margin-bottom: 0.5rem;
    }
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll('.admin-section').forEach(sec => sec.classList.add('hidden'));
    const firstSection = document.querySelector('.admin-section');
    if (firstSection) {
      firstSection.classList.remove('hidden');
    }

    const firstLink = document.querySelector('.admin-link');
    if (firstLink) {
      firstLink.classList.add('active');
    }

    document.querySelectorAll('.admin-link').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();

        document.querySelectorAll('.admin-link').forEach(l => l.classList.remove('active'));
        link.classList.add('active');

        document.querySelectorAll('.admin-section').forEach(sec => sec.classList.add('hidden'));
        document.querySelector(link.dataset.target).classList.remove('hidden');
      });
    });

    document.querySelectorAll('.accordion-toggle').forEach(btn => {
      btn.addEventListener('click', () => {
        const content = btn.nextElementSibling;
        const isOpen = btn.classList.contains('active');

        document.querySelectorAll('.accordion-toggle').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.accordion-content').forEach(c => c.style.display = 'none');

        if (!isOpen) {
          btn.classList.add('active');
          content.style.display = 'block';
        }
      });
    });

    const firstAccordion = document.querySelector('.accordion-toggle');
    if (firstAccordion) {
      firstAccordion.classList.add('active');
      const firstContent = firstAccordion.nextElementSibling;
      if (firstContent) firstContent.style.display = 'block';
    }

    document.querySelectorAll('.admin-link').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();

        const sectionId = link.dataset.target;
        localStorage.setItem('adminActiveSection', sectionId);

        document.querySelectorAll('.admin-link').forEach(l => l.classList.remove('active'));
        link.classList.add('active');

        document.querySelectorAll('.admin-section').forEach(sec => sec.classList.add('hidden'));
        document.querySelector(sectionId).classList.remove('hidden');
      });
    });

    window.addEventListener('load', () => {
      const savedSection = localStorage.getItem('adminActiveSection');
      if (savedSection) {
        document.querySelectorAll('.admin-link').forEach(l => l.classList.remove('active'));
        document.querySelectorAll('.admin-section').forEach(sec => sec.classList.add('hidden'));

        const link = document.querySelector(`.admin-link[data-target="${savedSection}"]`);
        const section = document.querySelector(savedSection);

        if (link && section) {
          link.classList.add('active');
          section.classList.remove('hidden');

          const group = link.closest('.accordion-content');
          if (group) {
            group.style.display = 'block';
            const toggle = group.previousElementSibling;
            if (toggle) toggle.classList.add('active');
          }
        }
      }
    });
  });
</script>
